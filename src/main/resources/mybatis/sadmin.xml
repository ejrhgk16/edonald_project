<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edonald.sadmin.dao.SadminMapper">
	<select id="listAll" resultType="com.edonald.hadmin.dto.MenuDto">
		SELECT * FROM menu m WHERE status != 0 AND type = #{type} ORDER BY status DESC,category_code,seq ASC
	</select>
	<select id="listBlock" resultType="int">
		SELECT m_seq FROM block_order_list WHERE store_code = #{store_code}
	</select>
	<insert id="insertBlock">
		INSERT INTO block_order_list VALUES(#{store},null,#{seq})
	</insert>
	<delete id="deleteBlock">
		DELETE FROM block_order_list WHERE store_code = #{store} AND m_seq = #{seq}
	</delete>
	<select id="getStore" resultType="com.edonald.hadmin.dto.StoreDto">
		SELECT * FROM store_list WHERE store_code = #{store_code}
	</select>
	<update id="updateStoreStatus">
		UPDATE store_list SET store_status = #{store_status} WHERE store_code = #{store_code}
	</update>
	<select id="getOrderList" resultType="com.edonald.order.dto.OrderListDto">
		SELECT * FROM order_list WHERE store_code = #{store_code} AND order_date >=  DATE_FORMAT(( NOW() - INTERVAL 6 DAY),'%Y-%m-%d') ORDER BY order_date DESC
	</select>
	<select id="getNewOrderList" resultType="com.edonald.order.dto.OrderListDto">
		SELECT * FROM order_list WHERE store_code = #{store_code} AND order_status = 0 AND order_seq > #{order_seq} ORDER BY order_seq DESC;
	</select>
	<select id="getCartList" resultType="com.edonald.order.dto.CartDto">
		SELECT * FROM cart_list WHERE merchanuid = #{merchanuid}
	</select>
	<update id="updateOrder">
		UPDATE order_list SET order_status = ${order_status} 
		<if test="delivery_time != null">
			, delivery_time = #{delivery_time}
		</if>
		WHERE order_seq = ${order_seq}
	</update>
	<select id="getOrderListBySeq" resultType="com.edonald.order.dto.OrderListDto">
		SELECT * FROM order_list WHERE order_seq = #{order_seq}
	</select>
	<select id="getSalesVolumeBySeq" resultType="int">
		SELECT IFNULL(a.count,0) counta
		FROM 
		( 
		SELECT date_format(ab.order_date, 
				<if test="monthorday == 'month'.toString">'%Y-%m'</if>
		    	<if test="monthorday == 'day'.toString">'%Y-%m-%d'</if>
		    	)as yyyymmdd, ifnull(sum(ab.cart_product_quant),0) count From 
			(SELECT ol.order_date, cl.cart_product_quant FROM order_list ol LEFT JOIN cart_list cl ON ol.merchanuid = cl.merchanuid 
			WHERE cl.cart_product_code = ${menu_code} AND ol.store_code = ${store_code}) ab 
		    GROUP BY DATE_FORMAT(ab.order_date, 
		    	<if test="monthorday == 'month'.toString">'%Y-%m'</if>
		    	<if test="monthorday == 'day'.toString">'%Y-%m-%d'</if>
		    	)
		) a  
		RIGHT JOIN  
		( 
		SELECT  @N := @N +1 AS n ,  
		DATE_FORMAT( DATE_ADD(
			<if test="monthorday == 'month'.toString"> LAST_DAY(NOW() - INTERVAL MONTH(NOW()) MONTH)+INTERVAL 1 DAY , INTERVAL @N -1 MONTH),'%Y-%m'</if>
			<if test="monthorday == 'day'.toString"> NOW() - INTERVAL 6 DAY , INTERVAL @N -1 DAY),'%Y-%m-%d'</if>
			) AS yyyymmdd  
		from (order_list), (SELECT @N:=0 FROM DUAL ) a  
		LIMIT 
			<if test="monthorday == 'month'.toString">12</if>
	    	<if test="monthorday == 'day'.toString">7</if>
		) b on a.yyyymmdd = b.yyyymmdd 
		ORDER BY b.yyyymmdd ASC
	</select>
	<select id="getSalesVolumeBySeqAndGender" resultType="int">
	SELECT IFNULL(a.count,0) counta
		FROM 
		( 
			SELECT DATE_FORMAT(ab.order_date,
				<if test="monthorday == 'month'.toString">'%Y-%m'</if>
		    	<if test="monthorday == 'day'.toString">'%Y-%m-%d'</if>
				) date_,ifnull(sum(ab.cart_product_quant),0) count
            From (SELECT ol.order_date, cl.cart_product_quant, ui.user_gender FROM order_list ol LEFT JOIN cart_list cl ON ol.merchanuid = cl.merchanuid  LEFT JOIN user_info ui ON ol.user_email = ui.user_email  
			WHERE cl.cart_product_code = ${menu_code} AND ol.store_code = ${store_code} AND ui.user_gender = #{user_gender}) ab 
			GROUP BY DATE_FORMAT(ab.order_date, 
				<if test="monthorday == 'month'.toString">'%Y-%m'</if>
		    	<if test="monthorday == 'day'.toString">'%Y-%m-%d'</if>
			)
		) a  
		RIGHT JOIN  
		( 
		SELECT  @N := @N +1 AS n ,  
		DATE_FORMAT( DATE_ADD( 
				<if test="monthorday == 'month'.toString"> LAST_DAY(NOW() - INTERVAL MONTH(NOW()) MONTH)+INTERVAL 1 DAY , INTERVAL @N -1 MONTH),'%Y-%m'</if>
				<if test="monthorday == 'day'.toString"> NOW() - INTERVAL 6 DAY , INTERVAL @N -1 DAY),'%Y-%m-%d'</if>
			) AS yyyymmdd 
		from (order_list), (SELECT @N:=0 FROM DUAL ) ac  
		LIMIT 
			<if test="monthorday == 'month'.toString">12</if>
	    	<if test="monthorday == 'day'.toString">7</if>
		) b on a.date_ = b.yyyymmdd 
		ORDER BY b.yyyymmdd ASC;
	</select>
	<select id="getMenuBySeq" resultType="com.edonald.hadmin.dto.MenuDto">
		SELECT * FROM menu WHERE seq = #{menu_code};
	</select>
	
	
	
	
	<select id="getChartDataAll" resultType="int">
		select ifnull(a.total,0)
		from
		<if test="dateStandard == 'month'.toString() ">
		(
		select date_format(order_date, '%Y-%m')as yyyymmdd, sum(final_price) as total from order_list
		<if test="search!=null and !search.equals('') ">where store_code = #{search}</if>
		group by
		date_format(order_date,'%Y-%m')
		) a
		right join
		(
			select @N := @N +1 AS n ,
			date_format( date_add( LAST_DAY(NOW() - interval Month(now()) month)+interval 1
			DAY , interval @N -1 month),'%Y-%m') as yyyymmdd
			from (order_list), (select @N:=0 from dual ) a
			limit 12
	)
	</if>
	<if test="dateStandard == 'day'.toString() ">
	  ( 
      SELECT DATE_FORMAT(order_date, '%Y-%m-%d') AS yyyymmdd, SUM(final_price) AS total
      FROM order_list 
      <if test="search!=null and !search.equals('') ">where store_code = #{search}</if>
      GROUP BY DATE_FORMAT(order_date, '%Y-%m-%d')  
      ) a  
      RIGHT JOIN  
      ( 
      SELECT  @N := @N +1 AS n ,  
      DATE_FORMAT( DATE_ADD( NOW() - INTERVAL 6 DAY , INTERVAL @N -1 DAY),'%Y-%m-%d') AS yyyymmdd  
      FROM (order_list), (SELECT @N:=0 FROM DUAL ) a  
      LIMIT 7
      )
	</if>
		 b on a.yyyymmdd = b.yyyymmdd
		order by b.yyyymmdd asc
	</select>
	
	<select id="getGenderSalesData" resultType="int">
		SELECT IFNULL(a.total,0) price
      FROM 
      <if test="dateStandard == 'month'.toString() ">
      ( 
      SELECT DATE_FORMAT(order_date, '%Y-%m') AS yyyymmdd, SUM(final_price) AS total
      FROM 
      (SELECT ol.order_date, ui.user_gender, final_price FROM order_list ol LEFT JOIN user_info ui ON ol.user_email = ui.user_email  
         WHERE ui.user_gender = #{sex}
         <if test="search!=null and !search.equals('') ">and ol.store_code = #{search}</if>
         ) ab 
      GROUP BY DATE_FORMAT(ab.order_date, '%Y-%m')  
      ) a  
      RIGHT JOIN  
      ( 
      SELECT  @N := @N +1 AS n ,  
      DATE_FORMAT( DATE_ADD( LAST_DAY(NOW() - interval Month(now()) month)+interval 1 DAY , interval @N -1 month),'%Y-%m') AS yyyymmdd  
      FROM (order_list), (SELECT @N:=0 FROM DUAL ) ac  
      LIMIT 12
      ) 
      </if>
      <if test="dateStandard == 'day'.toString() ">
        ( 
      SELECT DATE_FORMAT(order_date, '%Y-%m-%d') AS yyyymmdd, SUM(final_price) AS total
      FROM 
      (SELECT ol.order_date, ui.user_gender, final_price FROM order_list ol LEFT JOIN user_info ui ON ol.user_email = ui.user_email  
         WHERE ui.user_gender = #{sex}
         <if test="search!=null and !search.equals('') ">and ol.store_code = #{search}</if>
         ) ab 
      GROUP BY DATE_FORMAT(ab.order_date, '%Y-%m-%d')  
      ) a  
      RIGHT JOIN  
      ( 
      SELECT  @N := @N +1 AS n ,  
      DATE_FORMAT( DATE_ADD( NOW() - INTERVAL 6 DAY , INTERVAL @N -1 DAY),'%Y-%m-%d') AS yyyymmdd      
      FROM (order_list), (SELECT @N:=0 FROM DUAL ) ac  
      LIMIT 7
      ) 
      </if>
      b on a.yyyymmdd = b.yyyymmdd 
      ORDER BY b.yyyymmdd ASC;
		
	</select>
	
	<select id="getExcelData" resultType="com.edonald.order.dto.OrderListDto">
		select * from order_list where store_code = #{store_code} and order_date >=  DATE_FORMAT(( NOW() - INTERVAL 6 DAY),'%Y-%m-%d')
	</select>
	
	
	
</mapper>