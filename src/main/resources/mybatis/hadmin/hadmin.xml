<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edonald.hadmin.dao.HadminMapper">
	<insert id="insertPromotion">
		INSERT INTO promotion
		VALUES(null,#{p_title},#{p_img},default)
	</insert>
	<select id="getPromotionList"
		resultType="com.edonald.hadmin.dto.PromotionDto">
		SELECT * FROM promotion ORDER BY p_seq DESC
	</select>
	<select id="getPromotion"
		resultType="com.edonald.hadmin.dto.PromotionDto">
		SELECT * FROM promotion WHERE p_seq = #{p_seq}
	</select>
	<update id="updatePromotion">
		UPDATE promotion SET p_title = #{p_title}, p_status = #{p_status}
		<if test="p_img != null">, p_img = #{p_img} </if>
		WHERE p_seq = #{p_seq}
	</update>

	<select id="getChartDataAll" resultType="int">
		select ifnull(a.total,0)
		from
		<if test="dateStandard == 'month'.toString() ">
		(
		select date_format(order_date, '%Y-%m')as yyyymmdd, sum(final_price) as total from order_list
		<if test="search!=null and !search.equals('') ">where store_code = #{search}</if>
		group by
		date_format(order_date,'%Y-%m')
		) a
		right join
		(
			select @N := @N +1 AS n ,
			date_format( date_add( LAST_DAY(NOW() - interval Month(now()) month)+interval 1
			DAY , interval @N -1 month),'%Y-%m') as yyyymmdd
			from (order_list), (select @N:=0 from dual ) a
			limit 12
	)
	</if>
	<if test="dateStandard == 'day'.toString() ">
	  ( 
      SELECT DATE_FORMAT(order_date, '%Y-%m-%d') AS yyyymmdd, SUM(final_price) AS total
      FROM order_list 
      <if test="search!=null and !search.equals('') ">where store_code = #{search}</if>
      GROUP BY DATE_FORMAT(order_date, '%Y-%m-%d')  
      ) a  
      RIGHT JOIN  
      ( 
      SELECT  @N := @N +1 AS n ,  
      DATE_FORMAT( DATE_ADD( NOW() - INTERVAL 6 DAY , INTERVAL @N -1 DAY),'%Y-%m-%d') AS yyyymmdd  
      FROM (order_list), (SELECT @N:=0 FROM DUAL ) a  
      LIMIT 7
      )
	</if>
		 b on a.yyyymmdd = b.yyyymmdd
		order by b.yyyymmdd asc
	</select>
	
	<select id="getStoreName" resultType="String">
		select store_name from store_list where store_code = #{search}
	</select>
	
	<select id="getGenderSalesData" resultType="int">
	
		SELECT IFNULL(a.total,0) price
      FROM 
      <if test="dateStandard == 'month'.toString() ">
      ( 
      SELECT DATE_FORMAT(order_date, '%Y-%m') AS yyyymmdd, SUM(final_price) AS total
      FROM 
      (SELECT ol.order_date, ui.user_gender, final_price FROM order_list ol LEFT JOIN user_info ui ON ol.user_email = ui.user_email  
         WHERE ui.user_gender = #{sex}
         <if test="search!=null and !search.equals('') ">and ol.store_code = #{search}</if>
         ) ab 
      GROUP BY DATE_FORMAT(ab.order_date, '%Y-%m')  
      ) a  
      RIGHT JOIN  
      ( 
      SELECT  @N := @N +1 AS n ,  
      DATE_FORMAT( DATE_ADD( LAST_DAY(NOW() - interval Month(now()) month)+interval 1 DAY , interval @N -1 month),'%Y-%m') AS yyyymmdd  
      FROM (order_list), (SELECT @N:=0 FROM DUAL ) ac  
      LIMIT 12
      ) 
      </if>
      <if test="dateStandard == 'day'.toString() ">
        ( 
      SELECT DATE_FORMAT(order_date, '%Y-%m-%d') AS yyyymmdd, SUM(final_price) AS total
      FROM 
      (SELECT ol.order_date, ui.user_gender, final_price FROM order_list ol LEFT JOIN user_info ui ON ol.user_email = ui.user_email  
         WHERE ui.user_gender = #{sex}
         <if test="search!=null and !search.equals('') ">and ol.store_code = #{search}</if>
         ) ab 
      GROUP BY DATE_FORMAT(ab.order_date, '%Y-%m-%d')  
      ) a  
      RIGHT JOIN  
      ( 
      SELECT  @N := @N +1 AS n ,  
      DATE_FORMAT( DATE_ADD( NOW() - INTERVAL 6 DAY , INTERVAL @N -1 DAY),'%Y-%m-%d') AS yyyymmdd      
      FROM (order_list), (SELECT @N:=0 FROM DUAL ) ac  
      LIMIT 7
      ) 
      </if>
      b on a.yyyymmdd = b.yyyymmdd 
      ORDER BY b.yyyymmdd ASC;
		
	</select>
	<select id="getSalesVolumeBySeq" resultType="int">
		SELECT IFNULL(a.count,0) counta
		FROM 
		( 
		SELECT date_format(ab.order_date, 
				<if test="monthorday == 'month'.toString">'%Y-%m'</if>
		    	<if test="monthorday == 'day'.toString">'%Y-%m-%d'</if>
		    	)as yyyymmdd, ifnull(sum(ab.cart_product_quant),0) count From 
			(SELECT ol.order_date, cl.cart_product_quant FROM order_list ol LEFT JOIN cart_list cl ON ol.merchanuid = cl.merchanuid 
			WHERE cl.cart_product_code = ${menu_code}) ab 
		    GROUP BY DATE_FORMAT(ab.order_date, 
		    	<if test="monthorday == 'month'.toString">'%Y-%m'</if>
		    	<if test="monthorday == 'day'.toString">'%Y-%m-%d'</if>
		    	)
		) a  
		RIGHT JOIN  
		( 
		SELECT  @N := @N +1 AS n ,  
		DATE_FORMAT( DATE_ADD(
			<if test="monthorday == 'month'.toString"> LAST_DAY(NOW() - INTERVAL MONTH(NOW()) MONTH)+INTERVAL 1 DAY , INTERVAL @N -1 MONTH),'%Y-%m'</if>
			<if test="monthorday == 'day'.toString"> NOW() - INTERVAL 6 DAY , INTERVAL @N -1 DAY),'%Y-%m-%d'</if>
			) AS yyyymmdd  
		from (order_list), (SELECT @N:=0 FROM DUAL ) a  
		LIMIT 
			<if test="monthorday == 'month'.toString">12</if>
	    	<if test="monthorday == 'day'.toString">7</if>
		) b on a.yyyymmdd = b.yyyymmdd 
		ORDER BY b.yyyymmdd ASC
	</select>
	<select id="getSalesVolumeBySeqAndGender" resultType="int">
	SELECT IFNULL(a.count,0) counta
		FROM 
		( 
			SELECT DATE_FORMAT(ab.order_date,
				<if test="monthorday == 'month'.toString">'%Y-%m'</if>
		    	<if test="monthorday == 'day'.toString">'%Y-%m-%d'</if>
				) date_,ifnull(sum(ab.cart_product_quant),0) count
            From (SELECT ol.order_date, cl.cart_product_quant, ui.user_gender FROM order_list ol LEFT JOIN cart_list cl ON ol.merchanuid = cl.merchanuid  LEFT JOIN user_info ui ON ol.user_email = ui.user_email  
			WHERE cl.cart_product_code = ${menu_code} AND ui.user_gender = #{user_gender}) ab 
			GROUP BY DATE_FORMAT(ab.order_date, 
				<if test="monthorday == 'month'.toString">'%Y-%m'</if>
		    	<if test="monthorday == 'day'.toString">'%Y-%m-%d'</if>
			)
		) a  
		RIGHT JOIN  
		( 
		SELECT  @N := @N +1 AS n ,  
		DATE_FORMAT( DATE_ADD( 
				<if test="monthorday == 'month'.toString"> LAST_DAY(NOW() - INTERVAL MONTH(NOW()) MONTH)+INTERVAL 1 DAY , INTERVAL @N -1 MONTH),'%Y-%m'</if>
				<if test="monthorday == 'day'.toString"> NOW() - INTERVAL 6 DAY , INTERVAL @N -1 DAY),'%Y-%m-%d'</if>
			) AS yyyymmdd 
		from (order_list), (SELECT @N:=0 FROM DUAL ) ac  
		LIMIT 
			<if test="monthorday == 'month'.toString">12</if>
	    	<if test="monthorday == 'day'.toString">7</if>
		) b on a.date_ = b.yyyymmdd 
		ORDER BY b.yyyymmdd ASC;
	</select>
	<select id="getMenuBySeq" resultType="com.edonald.hadmin.dto.MenuDto">
		SELECT * FROM menu WHERE seq = #{menu_code};
	</select>
	
	<select id="getEachMenuSalesVolume" resultType="com.edonald.order.dto.CartDto">
	SELECT m.name AS cart_product_name,IFNULL(al.sum,0) AS cart_product_quant FROM menu m LEFT JOIN
		(SELECT cart_product_name, ifnull(SUM(cl.cart_product_quant),0) sum  FROM order_list ol LEFT JOIN cart_list cl ON ol.merchanuid = cl.merchanuid LEFT JOIN user_info ui ON ol.user_email = ui.user_email  
			WHERE 
				<choose>
					<when test="order_date != null">
						 MONTH(order_date) = MONTH(#{order_date})
					</when>
					<otherwise>
						 MONTH(order_date) = MONTH(NOW())
					</otherwise>
				</choose> 
				<if test="user_gender != 0">
				 AND user_gender = #{user_gender}  
				</if>
				 AND menu_type = #{menu_type}
			GROUP BY cl.cart_product_code ) al 
		ON m.name = al.cart_product_name WHERE m.type = #{menu_type}
		
	</select>
	
	<select id="getExcelData" resultType="com.edonald.order.dto.OrderListDto">
		select * from order_list where order_date >=  DATE_FORMAT(( NOW() - INTERVAL 6 DAY),'%Y-%m-%d')
	</select>
	
	<!-- dump -->
	<select id="getMenuSeqList" resultType="int">
		SELECT seq FROM menu
	</select>
	<select id="getMenuByCode" resultType="com.edonald.hadmin.dto.MenuDto">
		SELECT * From menu WHERE seq = ${code}
	</select>
	<insert id="insertOrderInfo">
		insert into order_list(user_type, user_name, order_date, user_address, user_phone, order_status, total_price, final_price, store_code, merchanuid, user_email, cupon_title, postcode, payment_type,delivery_time,discount)
										  values(#{user_type}, #{user_name}, #{order_date}, #{user_address}, #{user_phone}, #{order_status}, #{total_price}, #{final_price},  #{store_code}, #{merchanuid}, #{user_email}, #{cupon_title}, #{postcode}, #{payment_type}, #{delivery_time},0) 
	</insert>
	<insert id="insertCartInfo">
		insert into cart_list(cart_product_code, cart_product_name, cart_product_img_path, cart_product_price, cart_product_quant, merchanuid, menu_type, comp_type, calc_price)  
		values(#{cart_product_code}, #{cart_product_name}, #{cart_product_img_path}, #{cart_product_price}, #{cart_product_quant}, #{merchanuid}, #{menu_type}, #{comp_type}, #{calc_price}) 
	</insert>
</mapper>